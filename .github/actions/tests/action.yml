name: Tests
description: Run testing on Go code and check coverage
runs:
  using: "composite"
  steps:
    # Step 1: Checkout the repository code
    - name: Checkout code
      uses: actions/checkout@v2

    # Step 2: Set up Docker Buildx (optional)
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    # Step 3: Run docker-compose up to start the services
    - name: Start Docker Compose
      shell: bash
      run: docker-compose up -d  # Start the containers in the background (-d)

    # Step 4: Run the tests with coverage
    - name: Run Tests with Coverage
      shell: bash
      id: coverage
      run: |
        go test -coverprofile=coverage.out ./...
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')

        echo "Coverage is $coverage%"

        if (( $(echo "$coverage > 90" | bc -l) )); then
          echo "Coverage is greater than 90%"
          exit 0
        else
          echo "Coverage is not greater than 90%"
          exit 1
        fi

    # Step 5: Stop and clean up Docker containers
    - name: Stop and remove Docker containers
      shell: bash
      run: docker-compose down
