name: Tests
description: Run testing on Go code and check coverage
runs:
  using: "composite"
  steps:
    - name: Run Tests with Coverage
      shell: bash
      id: coverage
      run: |
        go test -cover github.com/GabrielEValenzuela/Payment-Registration-System/src/... -coverprofile=coverage.out && go tool cover -html=coverage.out -o coverage.html
        coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')

        echo "Coverage is $coverage%"

        if (( $(echo "$coverage > 90" | bc -l) )); then
          echo "Coverage is greater than 90%"
          exit 0
        else
          echo "Coverage is not greater than 90%"
          exit 1
        fi

    - uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: ./coverage.html
        retention-days: 7